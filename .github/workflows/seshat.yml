name: Seshat Scribe - Multi-Topic Scheduler
on:
  schedule:
    # Run hourly to check for due topics
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      topicId:
        description: 'Specific topic ID to generate (optional - leave empty to check all due topics)'
        required: false
        type: string
      topic:
        description: 'Custom topic string to generate (optional - overrides topicId)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Check which topics are due for generation (scheduled runs only)
      - name: Check due topics
        if: github.event_name == 'schedule'
        id: check_due
        env:
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
        run: |
          TOPICS=$(pnpm exec seshat check-due \
            --sanity-project ${{ secrets.SANITY_PROJECT_ID }} \
            --sanity-dataset production \
            --json)
          echo "topics=$TOPICS" >> $GITHUB_OUTPUT
          echo "Found due topics: $TOPICS"

      # Generate posts for all due topics
      - name: Generate for due topics
        if: github.event_name == 'schedule' && steps.check_due.outputs.topics != '[]'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
        run: |
          TOPICS='${{ steps.check_due.outputs.topics }}'
          echo "Processing topics: $TOPICS"

          for TOPIC_ID in $(echo $TOPICS | jq -r '.[]'); do
            echo "✦ Generating content for topic: $TOPIC_ID"
            pnpm exec seshat write \
              --topic-id "$TOPIC_ID" \
              --sanity-project ${{ secrets.SANITY_PROJECT_ID }} \
              --sanity-dataset production || echo "⚠️  Failed for topic: $TOPIC_ID"
          done

      # Manual generation with custom topic string (workflow_dispatch only)
      - name: Generate with custom topic
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.topic
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
        run: |
          echo "✦ Manual generation for custom topic: ${{ github.event.inputs.topic }}"
          pnpm exec seshat write \
            --topic "${{ github.event.inputs.topic }}" \
            --sanity-project ${{ secrets.SANITY_PROJECT_ID }} \
            --sanity-dataset production

      # Manual generation for specific topic ID (workflow_dispatch only)
      - name: Generate for specific topic
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.topicId && !github.event.inputs.topic
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
        run: |
          echo "✦ Manual generation for topic ID: ${{ github.event.inputs.topicId }}"
          pnpm exec seshat write \
            --topic-id "${{ github.event.inputs.topicId }}" \
            --sanity-project ${{ secrets.SANITY_PROJECT_ID }} \
            --sanity-dataset production

      # Summary
      - name: Summary
        if: always()
        run: |
          echo "✨ Seshat workflow completed"
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "Mode: Scheduled check"
            echo "Due topics: ${{ steps.check_due.outputs.topics }}"
          else
            echo "Mode: Manual dispatch"
            if [ -n "${{ github.event.inputs.topic }}" ]; then
              echo "Custom topic: ${{ github.event.inputs.topic }}"
            elif [ -n "${{ github.event.inputs.topicId }}" ]; then
              echo "Topic ID: ${{ github.event.inputs.topicId }}"
            else
              echo "No topic specified"
            fi
          fi
